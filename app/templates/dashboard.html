{% extends "base.html" %}

{% block title %}仪表盘 - Telegram Bot管理系统{% endblock %}

{% block content %}
<h1 class="mb-4">Telegram Bot管理系统</h1>

<!-- Bot状态卡片 -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">Bot状态</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div id="botInfo">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-light rounded-circle p-3 me-3">
                            <i class="fas fa-robot fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h4 id="botUsername">加载中...</h4>
                            <p id="botFirstName" class="text-muted mb-0">加载中...</p>
                        </div>
                        <div class="ms-auto">
                            <span id="botStatus" class="badge bg-secondary">未知</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex flex-wrap">
                    <div class="border rounded p-3 me-3 mb-3 text-center" style="min-width: 120px;">
                        <div class="fs-4 fw-bold" id="messagesCount">-</div>
                        <div class="text-muted">消息数</div>
                    </div>
                    <div class="border rounded p-3 me-3 mb-3 text-center" style="min-width: 120px;">
                        <div class="fs-4 fw-bold" id="commandsCount">-</div>
                        <div class="text-muted">命令数</div>
                    </div>
                    <div class="border rounded p-3 me-3 mb-3 text-center" style="min-width: 120px;">
                        <div class="fs-4 fw-bold" id="groupsCount">-</div>
                        <div class="text-muted">群组数</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot操作区 -->
        <div class="mt-3">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="commandInput" placeholder="输入命令，例如: /help">
                        <input type="text" class="form-control" id="chatIdInput" placeholder="聊天ID">
                        <button class="btn btn-primary" id="executeCommandBtn" type="button">执行命令</button>
                    </div>
                    <div class="form-text">直接执行Bot命令</div>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100" id="refreshBotInfoBtn">
                        <i class="fas fa-sync-alt me-2"></i>刷新Bot状态
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据统计卡片 -->
<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">用户统计</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column align-items-center">
                    <div class="display-4 fw-bold" id="userCount">0</div>
                    <div class="text-muted">总用户数</div>
                </div>
                <div class="d-flex justify-content-around mt-4">
                    <div class="text-center">
                        <div class="h5 fw-bold" id="activeUsers">0</div>
                        <div class="text-muted small">活跃用户</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 fw-bold" id="newUsers">0</div>
                        <div class="text-muted small">今日新用户</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">消息统计</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column align-items-center">
                    <div class="display-4 fw-bold" id="messageCount">0</div>
                    <div class="text-muted">总消息数</div>
                </div>
                <div class="d-flex justify-content-around mt-4">
                    <div class="text-center">
                        <div class="h5 fw-bold" id="todayMessages">0</div>
                        <div class="text-muted small">今日消息</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 fw-bold" id="avgMessagesPerDay">0</div>
                        <div class="text-muted small">日均消息</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">群组统计</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column align-items-center">
                    <div class="display-4 fw-bold" id="groupCount">0</div>
                    <div class="text-muted">总群组数</div>
                </div>
                <div class="d-flex justify-content-around mt-4">
                    <div class="text-center">
                        <div class="h5 fw-bold" id="supergroups">0</div>
                        <div class="text-muted small">超级群组</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 fw-bold" id="channels">0</div>
                        <div class="text-muted small">频道</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表 -->
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">今日消息统计</h5>
            </div>
            <div class="card-body">
                <canvas id="hourlyChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">本月消息趋势</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 执行结果提示 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="commandResultToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">命令执行结果</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="commandResultBody">
            命令已执行
        </div>
    </div>
</div>

<!-- 登录模态框 -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">用户登录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="alert alert-danger d-none" id="loginError">
                        登录失败，请检查用户名和密码
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="loginBtn">登录</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // 图表实例
    let hourlyChart, monthlyChart;
    let accessToken = localStorage.getItem('accessToken');
    
    // 检查是否已登录
    function checkLogin() {
        if (!accessToken) {
            showLoginModal();
            return false;
        }
        return true;
    }
    
    // 显示登录模态框
    function showLoginModal() {
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
    }
    
    // 登录函数
    function login(username, password) {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('password', password);
        
        fetch('/api/token', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('登录失败');
            }
            return response.json();
        })
        .then(data => {
            accessToken = data.access_token;
            localStorage.setItem('accessToken', accessToken);
            
            // 关闭模态框
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            loginModal.hide();
            
            // 加载数据
            loadStats();
            loadBotStatus();
        })
        .catch(error => {
            console.error('登录失败:', error);
            document.getElementById('loginError').classList.remove('d-none');
        });
    }

    // 初始化图表
    function initCharts() {
        // 小时统计图表
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        hourlyChart = new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [{
                    label: '消息数',
                    data: Array(24).fill(0),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 月度趋势图表
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        monthlyChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                datasets: [{
                    label: '消息数',
                    data: Array(daysInMonth).fill(0),
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // 获取请求头
    function getHeaders() {
        return {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        };
    }

    // 加载统计数据
    function loadStats() {
        if (!checkLogin()) return;
        
        fetch('/api/stats', {
            headers: getHeaders()
        })
        .then(response => {
            if (response.status === 401) {
                // 认证失败，清除token并显示登录框
                localStorage.removeItem('accessToken');
                accessToken = null;
                showLoginModal();
                throw new Error('认证失败，请重新登录');
            }
            return response.json();
        })
        .then(data => {
            console.log('Stats data:', data);
            updateDashboard(data);
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
    }
    
    // 加载Bot状态
    function loadBotStatus() {
        if (!checkLogin()) return;
        
        fetch('/api/bot/stats', {
            headers: getHeaders()
        })
        .then(response => {
            if (response.status === 401) {
                // 认证失败，清除token并显示登录框
                localStorage.removeItem('accessToken');
                accessToken = null;
                showLoginModal();
                throw new Error('认证失败，请重新登录');
            }
            return response.json();
        })
        .then(data => {
            console.log('Bot stats:', data);
            updateBotStatus(data);
        })
        .catch(error => {
            console.error('Error loading bot stats:', error);
        });
    }
    
    // 执行Bot命令
    function executeCommand() {
        if (!checkLogin()) return;
        
        const command = document.getElementById('commandInput').value;
        const chatId = document.getElementById('chatIdInput').value;
        
        if (!command || !chatId) {
            showToast('请输入命令和聊天ID', 'warning');
            return;
        }
        
        fetch('/api/bot/execute', {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({
                command: command,
                chat_id: parseInt(chatId)
            })
        })
        .then(response => {
            if (response.status === 401) {
                // 认证失败，清除token并显示登录框
                localStorage.removeItem('accessToken');
                accessToken = null;
                showLoginModal();
                throw new Error('认证失败，请重新登录');
            }
            return response.json();
        })
        .then(data => {
            console.log('Command executed:', data);
            showToast(`命令 ${data.command} 已执行，消息ID: ${data.message_id}`, 'success');
        })
        .catch(error => {
            console.error('Error executing command:', error);
            showToast('执行命令失败', 'danger');
        });
    }
    
    // 显示提示消息
    function showToast(message, type = 'primary') {
        const toast = document.getElementById('commandResultToast');
        const toastBody = document.getElementById('commandResultBody');
        
        toastBody.textContent = message;
        toastBody.className = `toast-body text-${type}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // 更新仪表盘数据
    function updateDashboard(data) {
        try {
            // 更新用户统计
            document.getElementById('userCount').textContent = data.user_count || 0;
            document.getElementById('activeUsers').textContent = data.member_count || 0;
            
            // 计算今日新用户数
            const todayNewUsers = Math.floor(Math.random() * 10); // 示例数据
            document.getElementById('newUsers').textContent = todayNewUsers;
            
            // 更新消息统计
            document.getElementById('messageCount').textContent = data.message_count || 0;
            
            // 计算今日消息数
            let todayMessages = 0;
            if (data.hourly_activity) {
                Object.values(data.hourly_activity).forEach(count => {
                    todayMessages += count;
                });
            }
            document.getElementById('todayMessages').textContent = todayMessages;
            
            // 计算日均消息数
            const avgMessagesPerDay = Math.round((data.message_count || 0) / 30);
            document.getElementById('avgMessagesPerDay').textContent = avgMessagesPerDay;
            
            // 更新群组统计
            document.getElementById('groupCount').textContent = data.group_count || 0;
            document.getElementById('supergroups').textContent = Math.floor((data.group_count || 0) * 0.7);
            document.getElementById('channels').textContent = Math.floor((data.group_count || 0) * 0.3);
            
            // 更新图表
            if (data.hourly_activity) {
                updateHourlyChart(data.hourly_activity);
            }
            if (data.monthly_trend) {
                updateMonthlyChart(data.monthly_trend);
            }
        } catch (e) {
            console.error('Error updating dashboard:', e);
        }
    }
    
    // 更新Bot状态
    function updateBotStatus(data) {
        try {
            const info = data.info || {};
            const stats = data.stats || {};
            
            // 更新Bot信息
            document.getElementById('botUsername').textContent = info.username || '未知Bot';
            document.getElementById('botFirstName').textContent = info.first_name || '未知';
            
            // 更新状态标识
            const statusBadge = document.getElementById('botStatus');
            if (info.is_connected) {
                statusBadge.textContent = '在线';
                statusBadge.className = 'badge bg-success';
            } else {
                statusBadge.textContent = '使用API';
                statusBadge.className = 'badge bg-warning text-dark';
            }
            
            // 更新统计数据
            document.getElementById('messagesCount').textContent = stats.processed_messages || 0;
            document.getElementById('commandsCount').textContent = stats.commands_handled || 0;
            document.getElementById('groupsCount').textContent = stats.groups_count || 0;
        } catch (e) {
            console.error('Error updating bot status:', e);
        }
    }

    // 更新小时图表
    function updateHourlyChart(hourlyData) {
        const hours = Array.from({length: 24}, (_, i) => i);
        const hourlyValues = hours.map(hour => hourlyData[hour] || 0);
        
        hourlyChart.data.datasets[0].data = hourlyValues;
        hourlyChart.update();
    }

    // 更新月度图表
    function updateMonthlyChart(monthlyData) {
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
        const monthlyValues = days.map(day => monthlyData[day] || 0);
        
        monthlyChart.data.datasets[0].data = monthlyValues;
        monthlyChart.update();
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        
        // 添加事件监听器
        document.getElementById('refreshBotInfoBtn').addEventListener('click', loadBotStatus);
        document.getElementById('executeCommandBtn').addEventListener('click', executeCommand);
        document.getElementById('loginBtn').addEventListener('click', function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            login(username, password);
        });
        
        // 初始检查登录状态并加载数据
        checkLogin();
        if (accessToken) {
            loadStats();
            loadBotStatus();
        }
    });
</script>
{% endblock %} 